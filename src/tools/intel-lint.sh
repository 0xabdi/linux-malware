#!/bin/sh

printf "Checking for missing modules\n"
for intelfilename in intel/*
do
	jq .title "${intelfilename}" | tr -d "\"" | cut -f 2 -d " " | grep "github\.com" | while read intelurl
	do
		if [ -z "$(grep "${intelurl}" .gitmodules)" ]
		then
			intelarea="$(jq .body "${intelfilename}" | tr -d "\"" | sed -e "s/\\\r/|/g" -e "s/\\\n/|/g" -e "s/\"/|/g" | tr "|" "\n" | grep -A 4 Area | egrep "^[A-Z]")"
			printf "%s,%s\n" "${intelurl}" "${intelarea}"
		fi
	done
done
printf "Checking for missing malware\n"
for intelfilename in intel/*
do
	if [ -n "$(egrep "virustotal\.com|bazaar\.abuse\.ch|samples\.vx-underground\.org|analyze\.intezer\.com" "${intelfilename}")" ]
	then
		if [ -z "$(egrep "blob|tree" "${intelfilename}")" ]
		then
			inteltitle="$(jq .title "${intelfilename}" | tr -d "\"" | cut -f 2 -d " ")"
			if [ -n "$(grep "wltm" "${intelfilename}")" ]
			then
				printf "%s,%s,wltm\n" "${intelfilename}" "${inteltitle}"
			else
				printf "%s,%s\n" "${intelfilename}" "${inteltitle}"
			fi
		fi
	fi
done
printf "Checking for incorrectly classified intel\n"
for intelfilename in intel/*
do
	if [ -z "$(egrep "Area([\\r\\n]+)(Press\/academia|Breach reports|Supply chain attacks|Malware reports|Malware samples|Malware binaries|Malware source|Malware PoCs|Offensive tools|Offensive techniques|Defensive tools|Defensive techniques|Defensive Yara|Personal rules|Other rules)" "${intelfilename}")" ]
	then
		inteltitle="$(jq .title "${intelfilename}")"
		printf "%s,%s\n" "${intelfilename}" "${inteltitle}"
	fi
done
