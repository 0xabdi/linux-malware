#!/bin/sh

printf "Checking for incorrectly classified intel\n"
for intelfilename in intel/*
do
	if [ -z "$(egrep "Area([\\r\\n]+)(Press\/academia|Breach reports|Supply chain attacks|Malware reports|Malware binaries|Malware source|Malware PoCs|Offensive tools|Offensive techniques|Defensive tools|Defensive techniques|Defensive Yara|Personal rules|Other rules)" "${intelfilename}")" ]
	then
		inteltitle="$(jq .title "${intelfilename}")"
		printf "classification,%s,%s\n" "${intelfilename}" "${inteltitle}"
	fi
done
printf "Checking for incorrectly missing tactics\n"
for intelfilename in intel/*
do
	if [ -z "$(egrep "Parent threat([\\r\\n]+)(Reconnaissance|Resource Development|Initial Access|Execution|Persistence|Privilege Escalation|Defense Evasion|Credential Access|Discovery|Lateral Movement|Collection|Command and Control|Exfiltration|Impact)" "${intelfilename}")" ]
	then
		inteltitle="$(jq .title "${intelfilename}")"
		printf "tactics,%s,%s\n" "${intelfilename}" "${inteltitle}"
	fi
done
printf "Checking for missing modules\n"
for intelfilename in intel/*
do
	jq .title "${intelfilename}" | tr -d "\"" | cut -f 2 -d " " | grep "github\.com" | while read intelurl
	do
		if [ -z "$(grep "${intelurl}" .gitmodules)" ]
		then
			intelarea="$(jq .body "${intelfilename}" | tr -d "\"" | sed -e "s/\\\r/|/g" -e "s/\\\n/|/g" -e "s/\"/|/g" | tr "|" "\n" | grep -A 4 Area | egrep "^[A-Z]")"
			printf "%s,%s\n" "${intelurl}" "${intelarea}"
		fi
	done
done
printf "Checking for missing malware\n"
for intelfilename in intel/*
do
	if [ -n "$(egrep "virustotal\.com|bazaar\.abuse\.ch|samples\.vx-underground\.org|analyze\.intezer\.com" "${intelfilename}")" ]
	then
		if [ -z "$(egrep "blob|tree" "${intelfilename}")" ]
		then
			inteltitle="$(jq .title "${intelfilename}" | tr -d "\"" | cut -f 2 -d " ")"
			if [ -n "$(grep "wltm" "${intelfilename}")" ]
			then
				printf "wltm,%s,%s\n" "${intelfilename}" "${inteltitle}"
			else
				printf "!wltm,%s,%s\n" "${intelfilename}" "${inteltitle}"
			fi
		fi
	fi
done
printf "Checking for tags\n"
for intelfilename in intel/*
do
	jq .title "${intelfilename}" | tr -d "\"" | cut -f 2 -d " " | egrep -v "imgur\.com|github\.com|\.yara|youtu\.be" | sed "s/twitter\.com/nitter.net/g" | egrep -v "pdf|jpg|jpeg" | while read articleurl
	do
		articlefilename="$(printf "%s" "${articleurl}" | tr ":/" "__")"
		if [ -f "articles/${articlefilename}.html" ]
		then
			printf "tags,%s," "$(jq .number "${intelfilename}")"
			for tag in /dev/shm LD_PRELOAD LKM eBPF cron
			do
				if [ -n "$(grep "${tag}" "articles/${articlefilename}.html")" ]
				then
					if [ -z "$(grep "uses:${tag}" "${intelfilename}")" ]
					then
						printf "%s," "${tag}"
					fi
				fi
			done
			printf "\n"
		fi
	done
done
