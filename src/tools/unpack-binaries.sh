#!/bin/sh

# Ensure the UPX executable path is correct
UPX_EXECUTABLE="/usr/local/src/upx-trunk/src/upx.out"

# Unpack all .zip files in the current directory
for filename in *.zip; do
  if [ -f "$filename" ]; then
    7z x "${filename}" -pinfected
    if [ $? -ne 0 ]; then
      echo "Failed to unpack ${filename}"
      exit 1
    fi
  else
    echo "No .zip files found."
  fi
done

# Rename .elf files based on their architecture
for filename in *.elf; do
  if [ -f "$filename" ]; then
    case $(file "${filename}") in
      *ARM*)
        mv "${filename}" "${filename}.arm"
        ;;
      *MIPS*)
        mv "${filename}" "${filename}.mips"
        ;;
      *0386*)
        mv "${filename}" "${filename}.x86"
        ;;
      *x86-64*)
        mv "${filename}" "${filename}.x86_64"
        ;;
      *Power*)
        mv "${filename}" "${filename}.ppc"
        ;;
      *SPARC*)
        mv "${filename}" "${filename}.sparc"
        ;;
      *SH*)
        mv "${filename}" "${filename}.sh"
        ;;
      *m68k*)
        mv "${filename}" "${filename}.m68k"
        ;;
      *)
        echo "Unknown architecture for ${filename}"
        ;;
    esac
  else
    echo "No .elf files found."
  fi
done

# Check if UPX executable exists
if [ ! -f "$UPX_EXECUTABLE" ]; then
  echo "UPX executable not found at $UPX_EXECUTABLE."
  exit 1
fi

# Unpack ELF files using UPX
for filename in *.elf*; do
  if [ -f "$filename" ]; then
    "$UPX_EXECUTABLE" -d -o "${filename}.unpacked" "${filename}"
    if [ $? -ne 0 ]; then
      echo "Failed to unpack ${filename} with UPX."
      exit 1
    fi
  else
    echo "No .elf files found for unpacking."
  fi
done

# Scan unpacked files with ClamAV
clamscan *.elf*
if [ $? -ne 0 ]; then
  echo "ClamAV scan failed."
  exit 1
fi

echo "Unpacking and scanning completed successfully."
