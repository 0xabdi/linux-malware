#!/bin/sh

# Ensure the UPX executable path is correct
UPX_EXECUTABLE="/usr/bin/upx"
# Ensure the Binwalk executable path is correct
BINWALK_EXECUTABLE="/usr/bin/binwalk"

# Unpack all .zip files in the directory and its subdirectories
zip_found=false
for filename in $(find . -type f -name '*.zip'); do
  if [ -f "$filename" ]; then
    7z x "${filename}" -pinfected
    if [ $? -ne 0 ]; then
      echo "Failed to unpack ${filename}"
      exit 1
    fi
    zip_found=true
  fi
done

if [ "$zip_found" = false ]; then
  echo "No .zip files found."
fi

# Rename .elf files based on their architecture in the directory and its subdirectories
elf_found=false
for filename in $(find . -type f -name '*.elf'); do
  if [ -f "$filename" ]; then
    case $(file "${filename}") in
      *ARM*)
        mv "${filename}" "${filename}.arm"
        ;;
      *MIPS*)
        mv "${filename}" "${filename}.mips"
        ;;
      *0386*)
        mv "${filename}" "${filename}.x86"
        ;;
      *x86-64*)
        mv "${filename}" "${filename}.x86_64"
        ;;
      *Power*)
        mv "${filename}" "${filename}.ppc"
        ;;
      *SPARC*)
        mv "${filename}" "${filename}.sparc"
        ;;
      *SH*)
        mv "${filename}" "${filename}.sh"
        ;;
      *m68k*)
        mv "${filename}" "${filename}.m68k"
        ;;
      *)
        echo "Unknown architecture for ${filename}"
        ;;
    esac
    elf_found=true
  fi
done

if [ "$elf_found" = false ]; then
  echo "No .elf files found."
fi

# Check if UPX executable exists
if [ ! -f "$UPX_EXECUTABLE" ]; then
  echo "UPX executable not found at $UPX_EXECUTABLE."
  exit 1
fi

# Unpack ELF files using UPX in the directory and its subdirectories
for filename in $(find . -type f -name '*.elf*'); do
  if [ -f "$filename" ]; then
    if ! "$UPX_EXECUTABLE" -t "$filename" > /dev/null 2>&1; then
      echo "$filename is not packed by UPX, skipping."
    else
      "$UPX_EXECUTABLE" -d -o "${filename}.unpacked" "${filename}"
      if [ $? -ne 0 ]; then
        echo "Failed to unpack ${filename} with UPX."
      else
        echo "Successfully unpacked ${filename} with UPX."
      fi
    fi
  fi
done

# Check if Binwalk executable exists
if [ ! -f "$BINWALK_EXECUTABLE" ]; then
  echo "Binwalk executable not found at $BINWALK_EXECUTABLE."
  exit 1
fi

# Unpack remaining files using Binwalk in the directory and its subdirectories
for filename in $(find . -type f -name '*.elf*'); do
  if [ -f "$filename" ]; then
    "$BINWALK_EXECUTABLE" -e "$filename"
    if [ $? -ne 0 ]; then
      echo "Failed to unpack ${filename} with Binwalk."
    else
      echo "Successfully unpacked ${filename} with Binwalk."
    fi
  fi
done

# Scan unpacked files with ClamAV in the directory and its subdirectories
for filename in $(find . -type f -name '*.elf*'); do
  if [ -f "$filename" ]; then
    clamscan "${filename}"
    if [ $? -ne 0 ]; then
      echo "ClamAV scan failed for ${filename}."
      exit 1
    fi
  fi
done

echo "Unpacking and scanning completed successfully."
