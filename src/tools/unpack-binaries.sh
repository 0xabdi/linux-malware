#!/bin/sh

# Directory where archives and binaries are stored
ARCHIVE_DIR="/path/to/your/archives"
OUTPUT_DIR="/path/to/your/output"
UPX_EXECUTABLE="/usr/local/src/upx-trunk/src/upx.out"

# Change to the archive directory
cd "$ARCHIVE_DIR" || { echo "Failed to change to archive directory: $ARCHIVE_DIR"; exit 1; }

# Check if there are any .zip files to unpack
if [ -z "$(ls -A *.zip 2>/dev/null)" ]; then
  echo "No .zip files found in $ARCHIVE_DIR."
  exit 1
fi

# Unpack .zip files
for filename in *.zip; do
  7z x "${filename}" -pinfected -o"$OUTPUT_DIR"
  if [ $? -ne 0 ]; then
    echo "Failed to unpack ${filename}"
    exit 1
  fi
done

# Change to the output directory
cd "$OUTPUT_DIR" || { echo "Failed to change to output directory: $OUTPUT_DIR"; exit 1; }

# Rename .elf files based on their architecture
for filename in *.elf; do
  if [ -n "$(file "${filename}" | grep ARM)" ]; then
    mv "${filename}" "${filename}.arm"
  elif [ -n "$(file "${filename}" | grep MIPS)" ]; then
    mv "${filename}" "${filename}.mips"
  elif [ -n "$(file "${filename}" | grep 0386)" ]; then
    mv "${filename}" "${filename}.x86"
  elif [ -n "$(file "${filename}" | grep x86-64)" ]; then
    mv "${filename}" "${filename}.x86_64"
  elif [ -n "$(file "${filename}" | grep Power)" ]; then
    mv "${filename}" "${filename}.ppc"
  elif [ -n "$(file "${filename}" | grep SPARC)" ]; then
    mv "${filename}" "${filename}.sparc"
  elif [ -n "$(file "${filename}" | grep SH)" ]; then
    mv "${filename}" "${filename}.sh"
  elif [ -n "$(file "${filename}" | grep m68k)" ]; then
    mv "${filename}" "${filename}.m68k"
  fi
done

# Check if UPX executable exists
if [ ! -f "$UPX_EXECUTABLE" ]; then
  echo "UPX executable not found at $UPX_EXECUTABLE."
  exit 1
fi

# Unpack ELF files using UPX
for filename in *.elf*; do
  "$UPX_EXECUTABLE" -d -o "${filename}.unpacked" "${filename}"
  if [ $? -ne 0 ]; then
    echo "Failed to unpack ${filename} with UPX."
    exit 1
  fi
done

# Scan unpacked files with ClamAV
clamscan *.elf*
if [ $? -ne 0 ]; then
  echo "ClamAV scan failed."
  exit 1
fi

echo "Unpacking and scanning completed successfully."
