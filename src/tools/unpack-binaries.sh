#!/bin/sh

# Ensure the UPX executable path is correct
UPX_EXECUTABLE="/usr/bin/upx"

# Unpack all .zip files in the directory and its subdirectories
zip_found=false
for filename in $(find . -type f -name '*.zip'); do
  if [ -f "$filename" ]; then
    7z x "${filename}" -pinfected
    if [ $? -ne 0 ]; then
      echo "Failed to unpack ${filename}"
      exit 1
    fi
    zip_found=true
  fi
done

if [ "$zip_found" = false ]; then
  echo "No .zip files found."
fi

# Rename .elf files based on their architecture in the directory and its subdirectories
elf_found=false
for filename in $(find . -type f -name '*.elf'); do
  if [ -f "$filename" ]; then
    case $(file "${filename}") in
      *ARM*)
        mv "${filename}" "${filename}.arm"
        ;;
      *MIPS*)
        mv "${filename}" "${filename}.mips"
        ;;
      *0386*)
        mv "${filename}" "${filename}.x86"
        ;;
      *x86-64*)
        mv "${filename}" "${filename}.x86_64"
        ;;
      *Power*)
        mv "${filename}" "${filename}.ppc"
        ;;
      *SPARC*)
        mv "${filename}" "${filename}.sparc"
        ;;
      *SH*)
        mv "${filename}" "${filename}.sh"
        ;;
      *m68k*)
        mv "${filename}" "${filename}.m68k"
        ;;
      *)
        echo "Unknown architecture for ${filename}"
        ;;
    esac
    elf_found=true
  fi
done

if [ "$elf_found" = false ]; then
  echo "No .elf files found."
fi

# Check if UPX executable exists
if [ ! -f "$UPX_EXECUTABLE" ]; then
  echo "UPX executable not found at $UPX_EXECUTABLE."
  exit 1
fi

# Unpack ELF files using UPX in the directory and its subdirectories
for filename in $(find . -type f -name '*.elf*'); do
  if [ -f "$filename" ]; then
    "$UPX_EXECUTABLE" -d -o "${filename}.unpacked" "${filename}"
    if [ $? -ne 0 ]; then
      echo "Failed to unpack ${filename} with UPX."
      exit 1
    fi
  fi
done

# Scan unpacked files with ClamAV in the directory and its subdirectories
for filename in $(find . -type f -name '*.elf*'); do
  if [ -f "$filename" ]; then
    clamscan "${filename}"
    if [ $? -ne 0 ]; then
      echo "ClamAV scan failed for ${filename}."
      exit 1
    fi
  fi
done

echo "Unpacking and scanning completed successfully."
